/*
 * Analogue.c
 *
 *  Created on: Apr 29, 2024
 *      Author: eleve
 */

#include <stm32g4xx_hal.h>
#include "Analogue.h"
extern ADC_HandleTypeDef hadc1;
extern TIM_HandleTypeDef htim6;

int adc_available = 0; // Indique si l'ADC à fini la conversion Analog->Digital
uint16_t adc_tab[32];
int sel = 0; // Sélection des 4 potentiomètres pour les MUX_Analogiques
edit_sel_pots(sel);

void Analogue_init(void)
{
	HAL_ADC_Start_DMA(&hadc1, (uint32_t*)adc_tab, 4); // Active l'ADC
	HAL_TIM_Base_Start(&htim6); // Appel la fonction Analogue_irq_callback() quand la conversion Analog->Digital est finie
}

void Analogue_irq_callback(void)
{
	adc_available = 1; // Indique que la conversion Analog->Digital est finie
}

void Analogue_process(void)
{
	if (adc_available == 1) // Si l'ADC a convertit la tension en numérique
	{
		printf("%u\t", sel);
		for(int itr = 0 ; itr < 4 ; itr++) // Affiche les valeurs numérique des 4 potentiomètres
		{
			printf("%u\t", adc_tab[itr]);
		}
		printf("\r\n");

		// Modifie les 4 potentiomètres sélectionnés
		if (sel == 7) {
			sel = 0;
		} else {
			sel += 1;
		}
		edit_sel_pots(sel);

		adc_available = 0;
	}
}

void edit_sel_pot(int sel) { // Modifie les 4 potentiomètres sélectionnés par les MUX_Analogiques
	HAL_GPIO_WritePin(...sel_0..., sel & 0x1);
	HAL_GPIO_WritePin(...sel_1..., sel & 0x2);
	HAL_GPIO_WritePin(...sel_2..., sel & 0x4);
	HAL_GPIO_WritePin(...sel_3..., sel & 0x8);
}
